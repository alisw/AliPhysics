AliAnalysisTask *AddTask_jbook_JPsi(TString config="1",
				    Bool_t gridconf=kFALSE,
				    Bool_t hasMC=kFALSE,
				    ULong64_t triggers=AliVEvent::kCentral | AliVEvent::kSemiCentral | AliVEvent::kMB){

  //get the current analysis manager
  AliAnalysisManager *mgr = AliAnalysisManager::GetAnalysisManager();
  if (!mgr) {
    Error("AddTask_jbook_JPsi", "No analysis manager found.");
    return 0;
  }

  //Do we have an MC handler?
  TString list = gSystem->Getenv("LIST");
  if(!list.IsNull()) {
    if( list.Contains("LHC10h")   || list.Contains("LHC11h")   ) hasMC=kFALSE;
    if( list.Contains("LHC11a10") || list.Contains("LHC12a17") ) hasMC=kTRUE;
  }

  //Do we have an AOD handler?
  Bool_t isAOD=(mgr->GetInputEventHandler()->IsA()==AliAODInputHandler::Class() ? kTRUE : kFALSE);

  // set AOD debug levels
  if(isAOD) {
    mgr->AddClassDebug("AliAODTrack", AliLog::kFatal);
    mgr->AddClassDebug("AliAODpidUtil", AliLog::kInfo);
  }

  //set config file name
  TString configFile("");
  printf("%s \n",gSystem->pwd());
  TString trainRoot=gSystem->Getenv("TRAIN_ROOT");

  // gsi config
  if (!trainRoot.IsNull())  configFile="$TRAIN_ROOT/jbook_jpsi/ConfigJpsi_jb_PbPb.C";
  // alien config
  else if(!gSystem->Exec("alien_cp alien:///alice/cern.ch/user/j/jbook/PWGDQ/dielectron/macrosJPSI/ConfigJpsi_jb_PbPb.C .")) {
    gSystem->Exec(Form("ls -l %s",gSystem->pwd()));
    configFile=Form("%s/ConfigJpsi_jb_PbPb.C",gSystem->pwd());
  }
  else {
    printf("ERROR: couldn't copy file %s from grid \n",
	   "alien:///alice/cern.ch/user/j/jbook/PWGDQ/dielectron/macrosJPSI/ConfigJpsi_jb_PbPb.C");
    return;
  }

  // aliroot config
  if(!gridconf && trainRoot.IsNull())
    configFile="$ALICE_ROOT/PWGDQ/dielectron/macrosJPSI/ConfigJpsi_jb_PbPb.C"; // aliroot config

  // load efficiency maps
  if(!gSystem->Exec("alien_cp alien:///alice/cern.ch/user/j/jbook/PWGDQ/dielectron/files/effMap*.root ."))
    gSystem->Exec(Form("ls -l %s",gSystem->pwd()));
  else {
    printf("ERROR: couldn't copy file %s from grid \n",
           "alien:///alice/cern.ch/user/j/jbook/PWGDQ/dielectron/files/effMap*.root");
    return;
  }

  }
  //create task
  AliAnalysisTaskMultiDielectron *task;

  // trigger selection
  ULong64_t triggerSets[]={AliVEvent::kCentral , AliVEvent::kSemiCentral , AliVEvent::kMB,
			   AliVEvent::kCentral | AliVEvent::kSemiCentral | AliVEvent::kMB};
  const char* triggerNames[]={"Central","SemiCentral","MB","ALL"};
  const char* onlineRejection[]={"","CCENT","",""};

  // find out the configured triggers
  Int_t j=0;
  for(j=0; j<4; j++) {
    if(triggers!=triggerSets[j]) continue;
    else break;
  }

  // print overall configuration
  printf("production: %s MC: %d \n",  list.Data(),hasMC);
  printf("triggers:   %s \n",         triggerNames[j]  );
  printf("config:     %s Grid: %d \n",configFile.Data(),gridconf);

  //load dielectron configuration file (only once)
  TString checkconfig="ConfigJpsi_jb_PbPb";
  if (!gROOT->GetListOfGlobalFunctions()->FindObject(checkconfig.Data()))
    gROOT->LoadMacro(configFile.Data());

  //define default output container
  TString containerName = "JPSI.root";

  //add dielectron analysis with different cuts to the task
  for (Int_t i=0; i<nDie; ++i) { //nDie defined in config file

    //only configs switched ON will pass
    if(config.Length()<=i || config(i,1)!="1") { printf(" %d switched OFF \n",i); continue; }

    // load configuration
    AliDielectron *jpsi=ConfigJpsi_jb_PbPb(i,hasMC,triggers);
    if(!jpsi) continue;

    // create unique title
    TString unitit = Form("%s_%s",triggerNames[j],jpsi->GetName());

    // create single tasks instead of one multi task (decreasing size of CF container)
    task = new AliAnalysisTaskMultiDielectron(Form("MultiDieJB_%s",unitit.Data()));
    task->SetBeamEnergy(1380.);
    task->SetTriggerMask(triggers);
    if(strlen(onlineRejection[j])) task->SetFiredTriggerName(onlineRejection[j],kTRUE);
    if(!hasMC) task->UsePhysicsSelection();

    // event filter
    AliDielectronEventCuts *eventCuts=new AliDielectronEventCuts("vertex","vertex");
    if(isAOD) eventCuts->SetVertexType(AliDielectronEventCuts::kVtxAny);
    eventCuts->SetRequireVertex();
    eventCuts->SetMinVtxContributors(1);
    eventCuts->SetVertexZ(-10.,+10.);
    eventCuts->SetCentralityRange(0,90.);
    eventCuts->Print();
    task->SetEventFilter(eventCuts);
   
    // add dielectron to the task and manager
    task->AddDielectron(jpsi);
    mgr->AddTask(task);

    //create output sub containers
    AliAnalysisDataContainer *cOutputHist1 =
      mgr->CreateContainer(Form("jbook_QA_%s",unitit.Data()),
			   TList::Class(),
			   AliAnalysisManager::kOutputContainer,
			   containerName.Data());
    
    AliAnalysisDataContainer *cOutputHist2 =
      mgr->CreateContainer(Form("jbook_CF_%s",unitit.Data()),
			   TList::Class(),
			   AliAnalysisManager::kOutputContainer,
			   containerName.Data());
    
    AliAnalysisDataContainer *cOutputHist3 =
      mgr->CreateContainer(Form("jbook_EventStat_%s",unitit.Data()),
			   TH1D::Class(),
			   AliAnalysisManager::kOutputContainer,
			   containerName.Data());

    mgr->ConnectInput(task,  0, mgr->GetCommonInputContainer());
    //  mgr->ConnectOutput(task, 0, coutput1 );
    mgr->ConnectOutput(task, 1, cOutputHist1);
    mgr->ConnectOutput(task, 2, cOutputHist2);
    mgr->ConnectOutput(task, 3, cOutputHist3);

    printf(" %s added\n",jpsi->GetName());

  }


  return task;
}
