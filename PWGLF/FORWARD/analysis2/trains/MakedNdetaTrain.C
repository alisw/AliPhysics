/**
 * @file   MakedNdetaTrain.C
 * @author Christian Holm Christensen <cholm@master.hehi.nbi.dk>
 * @date   Fri Jun  1 13:51:26 2012
 * 
 * @brief  
 * 
 * @ingroup pwglf_forward_trains_specific
 * 
 */

#include "TrainSetup.C"

//====================================================================
/**
 * Analysis train to make @f$ dN/d\eta@f$
 * 
 *
 * @ingroup pwglf_forward_dndeta
 * @ingroup pwglf_forward_trains_specific
 */
class MakedNdetaTrain : public TrainSetup
{
public:
  /** 
   * Constructor.  
   * 
   * @param name     Name of train (free form)
   */
  MakedNdetaTrain(const char* name)
  : TrainSetup(name)
  {
    fOptions.Add("trig",     "TYPE", "Trigger type", "INEL");
    fOptions.Add("vzMin",    "CENTIMETER", "Min Ip Z", "-10");
    fOptions.Add("vzMax",    "CENTIMETER", "Max Ip Z", "+10");
    fOptions.Add("scheme",   "SCHEME", "Normalization scheme", "EVENT,TRIGGER");
    fOptions.Add("trigEff",  "EFFICENCY", "Trigger effeciency", "1");
    fOptions.Add("trigEff0", "EFFICENCY", "0-bin trigger effeciency", "1");
    fOptions.Add("cent",     "ESTIMATOR", "Use centrality", "none");
    fOptions.Add("centBins", "EDGES", "Centrality bin edges", "");
    fOptions.Add("mc",       "Also make dN/deta for MC truth");
    fOptions.Add("satellite","Restrict analysis to satellite events", false);
    fOptions.Add("outliers", "Ignore SPD outlier events", true);
    fOptions.Add("forward-config", "FILE", "Forward configuration", 
		 "dNdetaConfig.C");
    fOptions.Add("central-config", "FILE", "Central configuration", 
		 "dNdetaConfig.C");
    fOptions.Add("truth-config", "FILE", "MC-Truth configuration", 
		 "dNdetaConfig.C");
  }
protected:
  Bool_t CoupledNdetaCar(const char* which,
			 const char* cfg)
  {
    AliAnalysisTaskSE* tsk = CoupleSECar("AddTaskdNdeta.C",
					 Form("\"%s\",\"%s\"", which, cfg));
    if (!tsk) {
      Printf("Failed to add task via %s(%s)", macro, cfg);
      return false;
    }
    FromOption(tsk, "TriggerMask",         "trig",     "INEL");
    FromOption(tsk, "NormalizationScheme", "scheme",   "EVENT,TRIGGER");
    FromOption(tsk, "IpZMin",              "vzmin",    -10.);
    FromOption(tsk, "IpZMax",              "vzmax",    +10.);
    FromOption(tsk, "TriggerEff",          "trigEff",  1.);
    FromOption(tsk, "TriggerEff0",         "trigEff0", 1.);
    FromOption(tsk, "CentralityMethod",    "cent",     "");
    FromOption(tsk, "CentralityAxis",      "centBins",
	       "0:5:10:20:30:40:50:60:80:101");
    FromOption(tsk, "SatelliteVertices",   "satellite", false);
    FromOption(tsk, "CheckSPDOutlier",     "outliers", true);
    return true;

  }
  /** 
   * Create the tasks 
   * 
   */
  void CreateTasks(AliAnalysisManager*)
  {
    // --- Output file name ------------------------------------------
    AliAnalysisManager::SetCommonFileName("forward_dndeta.root");

    // --- Load libraries/pars ---------------------------------------
    fRailway->LoadLibrary("PWGLFforward2");
    // fRailway->LoadLibrary("AOD");
    // gSystem->ListLibraries();
    // gSystem->Load("libAOD");

    // --- Set load path ---------------------------------------------
    gROOT->SetMacroPath(Form("%s:$(ALICE_PHYSICS)/PWGLF/FORWARD/analysis2",
			     gROOT->GetMacroPath()));

    // --- Get parameters --------------------------------------------
    Bool_t   mc      = fOptions.Has("mc");
    TString  fwdCfg  = fOptions.Get("forward-config");
    TString  cenCfg  = fOptions.Get("central-config");
    TString  mcCfg   = fOptions.Get("truth-config");
    if (!mc) mc      = fRailway->IsMC(); 

    // --- Add the task ----------------------------------------------
    CoupledNdetaCar("Forward", fwdCfg);
    CoupledNdetaCar("Central", cenCfg);
    if (mc) CoupledNdetaCar("MCTruth", mcCfg);
  }
  //__________________________________________________________________
  /** 
   * Do not the centrality selection
   */
  //__________________________________________________________________
  void CreateCentralitySelection(Bool_t) {}
  /** 
   * Do not create MC input handler 
   * 
   * @return Always null
   */
  AliVEventHandler* CreateMCHandler(UShort_t, bool) { return 0; }
  //__________________________________________________________________
  /** 
   * Crete output handler - we don't want one here. 
   * 
   * @return 0
   */
  AliVEventHandler* CreateOutputHandler(UShort_t) { return 0; }
  //__________________________________________________________________
  const char* ClassName() const { return "MakedNdetaTrain"; }
  //__________________________________________________________________
  /** 
   * Overloaded to create new draw.C 
   * 
   * @param asShellScript 
   */
  void SaveSetup(Bool_t asShellScript)
  {
    TrainSetup::SaveSetup(asShellScript);

    SaveDraw();
    SaveSummarize();
  }
  void SaveSummarize()
  {
    std::ofstream f("Summarize.C");
    if (!f) { 
      Error("SaveSummarize", "Failed to open Summarize.C script");
      return;
    }
    f << "// Generated by " << ClassName() << "\n"
      << "// WHAT is a bit mask of\n"
      << "//   0x001     Forward\n"
      << "//   0x002     Central\n"
      << "//   0x004     Sums\n"
      << "//   0x008     Results\n"
      << "//   0x010     Only min-bias (no centrality)\n"
      << "//   0x080     Assume simulation results\n"
      << "//   0x100     Landscape\n"
      << "//   0x200     Pause\n"
      << "//   0x400     Also draw single result canvas\n"
      << "//\n"
      << "void Summarize(const char* filename=\"forward_dndeta.root\",\n"
      << "               UShort_t what=0x10F)\n"
      << "{\n"
      << "  const char* fwd=\"$ALICE_PHYSICS/PWGLF/FORWARD/analysis2\";\n"
      << "  gROOT->LoadMacro(Form(\"%s/DrawdNdetaSummary.C\",fwd));\n"
      << "  DrawdNdetaSummary(filename,what & 0x3FF);\n"
      << "\n"
      << "  if (!(what & 0x400)) return;\n"
      << "  gROOT->SetMacroPath(Form(\"../:%s\",gROOT->GetMacroPath()));\n"
      << "  gROOT->Macro(\"Draw.C\");\n"
      << "}\n"
      << "// EOF" << std::endl;
    f.close();
  }
  /** 
   * Make a ROOT script to draw results 
   * 
   */
  void SaveDraw()
  {
    std::ofstream o("Draw.C");
    if (!o) { 
      Error("MakedNdetaTrain::SaveSetup", "Failed to open Draw.C");
      return;
    }

    o << "// Created by " << ClassName() << "\n"
      << "Bool_t SetupDrawer(const TString& title, Bool_t old)\n"
      << "{\n"
      << "  const char* fwd=\"$ALICE_PHYSICS/PWGLF/FORWARD/analysis2\";\n"
      << "  gROOT->LoadMacro(Form(\"%s/DrawdNdeta.C+\",fwd));\n"
      << "  if (title.EqualTo(\"help\",TString::kIgnoreCase)) {\n"
      << "    if (old)\n"
      << "      DrawdNdeta(\"help\",\"\",5); // Get the help\n"
      << "    else\n"
      << "      DrawdNdeta(\"help\",\"\",\"\"); // Get the help\n"
      << "    return false;\n"
      << "  }\n"
      << "  return true;\n"
      << "}\n"
      << std::endl;
    o << "// Will draw dN/deta results from produced file\n"
      << "// \n"
      << "// Options can be specified as needed. To get help, pass the\n"
      << "// string \"help\" for the title:\n"
      << "// \n"
      << "//   root -l Draw.C\\(\\\"help\\\"\\)\n"
      << "// \n";
    o << "// Options:\n"
      << "//   0x00001      ShowRatios\n" 
      << "//   0x00002   ShowLeftRight\n" 
      << "//   0x00004    ShowSysError\n" 
      << "//   0x00008       ShowRings\n"
      << "//   0x00010        CutEdges\n"
      << "//   0x00020    RemoveOuters\n" 
      << "//   0x00040      UseFinalMC\n"
      << "//   0x00080    UseEmpirical\n"
      << "//   0x00100         ForceMB\n"
      << "//   0x00200          Mirror\n"
      << "//   0x00400          Export\n" 
      << "//   0x00800         AddExec\n"
      << "//   0x01000       OldFormat\n"
      << "//   0x02000         Verbose\n"
      << "//   0x04000           HiRes\n"
      << "//   0x08000      ExtraWhite\n"
      << "//   0x10000            Logo\n"
      << "//   0x20000       NoCentral\n"
      << "//   0x40000        NoLabels\n";
    o << "void Draw(const TString& title=\"" << fName << "\",\n"
      << "          UShort_t       rebin=5,\n"
      << "          UShort_t       others=0xf,\n"
      << "          UInt_t         flags=0x1C487,\n"
      << "          UShort_t       sNN=0,\n"
      << "          UShort_t       sys=0,\n"
      << "          UShort_t       trg=0,\n"
      << "          Float_t        eff=0,\n"
      << "          UShort_t       centMin=0,\n"
      << "          UShort_t       centMax=100,\n"
      << "          Float_t        vzMin=999,\n"
      << "          Float_t        vzMax=-999)\n"
      << "{\n"
      << "  if (!SetupDrawer(title, true)) return;\n"
      << "  DrawdNdeta(\"forward_dndeta.root\",\n"
      << "             title,\n"
      << "             rebin,\n"
      << "             others,\n"
      << "             flags,\n"
      << "             sNN,\n"
      << "             sys,\n"
      << "             trg,\n"
      << "             eff,\n"
      << "             centMin,\n"
      << "             centMax,\n"
      << "             vzMin,\n"
      << "             vzMax,\n"
      << "              \"dNdeta_<trig>\");\n"
      << "}\n"
      << std::endl;
    o << "// Alternative using strings\n"
      << "void Draw(const TString& title,\n"
      << "          const TString& others=\"ALL\",\n"
      << "          const TString& options=\"DEFAULT\",\n"
      << "          const TString& formats=\"ALL\",\n"
      << "          UShort_t       rebin=5,\n"
      << "          Float_t        eff=0,\n"
      << "          UShort_t       centMin=0,\n"
      << "          UShort_t       centMax=0,\n"
      << "          Float_t        vzMin=+999,\n"
      << "          Float_t        vzMax=-999,\n"
      << "          const TString& base="")\n"
      << "{\n"
      << "  if (!SetupDrawer(title, false)) return;\n"
      << "  DrawdNdeta(\"forward_dndeta.root\",\n"
      << "             title,others,options,formats,\n"
      << "             rebin,eff,centMin,centMax,\n"
      << "             vzMin,vzMax,\"dNdeta_<trig>\");\n"
      << "}\n"  
      << "//\n"
      << "// EOF\n"
      << "//" << std::endl;
    o.close();
  }
  void PostShellCode(std::ostream& f)
  {
    f << "  echo \"=== Summarizing results ...\"\n"
      << "  aliroot -l -b -q ${prefix}Summarize.C\n"
      << "  echo \"=== Draw results ...\"\n"
      << "  aliroot -l -b -q ${prefix}Draw.C\n"
      << std::endl;
  }
};
//
// EOF
//
