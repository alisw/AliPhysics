\documentclass[11pt]{article}
\usepackage[margin=2cm,twoside,a4paper]{geometry}
\usepackage{amstext}
\usepackage{amsmath}
\usepackage[ruled,vlined,linesnumbered]{algorithm2e}
\usepackage{graphicx}
\usepackage{color}
\usepackage{units}
\usepackage{listings}
\usepackage[colorlinks,urlcolor=black,hyperindex,%
            linktocpage,a4paper,bookmarks=true,%
            bookmarksopen=true,bookmarksopenlevel=2,%
            bookmarksnumbered=true]{hyperref}
%% \usepackage{bookmark}
\def\AlwaysText#1{\ifmmode\relax\text{#1}\else #1\fi}
\newcommand{\AbbrName}[1]{\AlwaysText{{\scshape #1}}}
\newcommand{\CERN}{\AbbrName{cern}}
\newcommand{\ALICE}{\AbbrName{alice}}
\newcommand{\SPD}{\AbbrName{spd}}
\newcommand{\ESD}{\AbbrName{esd}}
\newcommand{\AOD}{\AbbrName{aod}}
\newcommand{\INEL}{\AbbrName{inel}}
\newcommand{\INELONE}{$\AbbrName{inel}>0$}
\newcommand{\NSD}{\AbbrName{nsd}}
\newcommand{\FMD}[1][]{\AbbrName{fmd\ifx|#1|\else#1\fi}}
\newcommand{\OCDB}{\AbbrName{ocdb}}
\newcommand{\mult}[1][]{\ensuremath N_{\text{ch}#1}}
\newcommand{\dndetadphi}[1][]{{\ensuremath% 
    \ifx|#1|\else\left.\fi%
    \frac{d^2\mult{}}{d\eta\,d\varphi}%
    \ifx|#1|\else\right|_{#1}\fi%
}}
\newcommand{\landau}[1]{{\ensuremath% 
    \text{landau}\left(#1\right)}}
\newcommand{\dndeta}[1][]{{\ensuremath% 
    \ifx|#1|\else\left.\fi%
    \frac{1}{N}\frac{d\mult{}}{d\eta}%
    \ifx|#1|\else\right|_{#1}\fi%
}}
\newcommand{\MC}{\AlwaysText{MC}}
\newcommand{\N}[2]{{\ensuremath N_{#1#2}}}
\newcommand{\NV}[1][]{\N{\text{V}}{#1}}
\newcommand{\NnotV}{\N{\not{\text{V}}}}
\newcommand{\NT}{\N{\text{T}}{}}
\newcommand{\NA}{\N{\text{A}}{}}
\newcommand{\Ngood}{{\ensuremath N_{\text{good}}}}
\newcommand{\GeV}[1]{\unit[#1]{\AlwaysText{GeV}}}
\newcommand{\cm}[1]{\unit[#1]{\AlwaysText{cm}}}
\newcommand{\secref}[1]{Section~\ref{#1}}
\newcommand{\figref}[1]{Figure~\ref{#1}}
\newcommand{\etaphi}{\ensuremath(\eta,\varphi)}
% Azimuthal acceptance
\newcommand{\Corners}{\ensuremath A^{\varphi}_{t}} 
% Acceptance due to dead strips
\newcommand{\DeadCh}{\ensuremath A^{\eta}_{v,i}\etaphi} 
\newcommand{\SecMap}{\ensuremath S_v\etaphi}
\setlength{\parskip}{1ex}
\setlength{\parindent}{0em}
\title{Analysing the FMD data for $\dndeta$}
\author{Christian Holm
  Christensen\thanks{\texttt{$\langle$cholm@nbi.dk$\rangle$}}\quad\&\quad
  Hans Hjersing Dalsgaard\thanks{\texttt{$\langle$canute@nbi.dk$\rangle$}}\\ 
  Niels Bohr Institute\\
  University of Copenhagen}
\date{\today}
\begin{document}
\pdfbookmark{Analysing the FMD data for dN/deta}{top}
\maketitle 

\tableofcontents 
\section{Introduction}

This document describes the steps performed in the analysis of the
charged particle multiplicity in the forward pseudo--rapidity
regions.  The primary detector used for this is the \FMD{}
\cite{FWD:2004mz,cholm:2009}. 

The \FMD{} is
organised in 3 \emph{sub--detectors} \FMD{1}, \FMD{2}, and \FMD{3}, each
consisting of 1 (\FMD{1}) or 2 (\FMD{2} and~3) \emph{rings}.
The rings fall into two types: \emph{Inner} or \emph{outer} rings.
Each ring is in turn  azimuthally divided into \emph{sectors}, and each
sector is radially divided into \emph{strips}.  How many sectors,
strips, as well as the $\eta$ coverage is given in
\tablename~\ref{tab:fmd:overview}. 

\begin{table}[htbp]
  \begin{center}
    \caption{Physical dimensions of Si segments and strips.}
    \label{tab:fmd:overview}
    \vglue0.2cm
    \begin{tabular}{|c|cc|cr@{\space--\space}l|r@{\space--\space}l|}
      \hline
      \textbf{Sub--detector/} &
      \textbf{Azimuthal}&
      \textbf{Radial} &
      $z$ &
      \multicolumn{2}{c|}{\textbf{$r$}} &
      \multicolumn{2}{c|}{\textbf{$\eta$}} \\
      \textbf{Ring}& 
      \textbf{sectors} &
      \textbf{strips} & 
      \textbf{[cm]} &
      \multicolumn{2}{c|}{\textbf{range [cm]}} &
      \multicolumn{2}{c|}{\textbf{coverage}} \\
      \hline
      FMD1i & 20& 512& 320  &  4.2& 17.2& 3.68&  5.03\\
      FMD2i & 20& 512&  83.4&  4.2& 17.2& 2.28&  3.68\\
      FMD2o & 40& 256&  75.2& 15.4& 28.4& 1.70&  2.29\\
      FMD3i & 20& 512& -75.2&  4.2& 17.2&-2.29& -1.70\\
      FMD3o & 40& 256& -83.4& 15.4& 28.4&-3.40& -2.01\\
      \hline
    \end{tabular}
  \end{center}
\end{table}

The \FMD{} \ESD{} object contains the scaled energy deposited $\Delta
E/\Delta E_{mip}$ for each of the 51,200 strips.  This is determined
in the reconstruction pass.  The scaling to $\Delta E_{mip}$ is done
using calibration factors extracted in designated pulser runs.  In
these runs, the front-end electronics is pulsed with an increasing
known pulse size, and the conversion factor from ADC counts to $\Delta
E_{mip}$  is determined \cite{cholm:2009}.  

The \SPD{} is used for determination of the position of the primary
interaction point.

The analysis is performed as a two--step process.  
\begin{enumerate}
\item The Event--Summary--Data (\ESD{}) is processed event--by--event
  and passed through a number of algorithms, and
  $\dndetadphi$ for each event is output to an Analysis--Object--Data
  (\AOD{}) tree (see \secref{sec:gen_aod}).
\item The \AOD{} data is read in and the sub--sample of the data under
  investigation is selected (e.g., \INEL{}, \INELONE{}, \NSD{}, or
  some centrality class) and the $\dndetadphi$ histogram read in for
  those events to build up $\dndeta$ (see \secref{sec:ana_aod}).
\end{enumerate}
The details of each step above will be expanded upon in the
following. 

In Appendix~\ref{app:nomen} is an overview of the nomenclature used in
this document. 



\section{Generating $\dndetadphi[i]$ event--by--event}
\label{sec:gen_aod}

When reading in the \ESD{}s and generating the $\dndetadphi$
event--by--event the following steps are taken (in order) for each
event $i$
\begin{description}
\item[Event inspection] The global properties of the event is
  determined, including the trigger type and primary interaction
  point\footnote{`Vertex' and `primary interaction point' will be used
    interchangeably in the text, since there is no ambiguity with
    particle production vertex in this analysis.} $z$ coordinate (see
  \secref{sec:sub:event_inspection}).  
\item[Sharing filter] The \ESD{} object is read in and corrected for
  sharing.  The result is a new \ESD{} object (see
  \secref{sec:sub:sharing_filter}). 
\item[Density calculator] The (possibly un--corrected) \ESD{} object
  is then inspected and an inclusive (primary \emph{and} secondary
  particles), per--ring charged particle density
  $\dndetadphi[incl,r,v,i]$ is made.  This calculation depends in
  general upon the interaction vertex position along the $z$ axis
  $v_z$ (see \secref{sec:sub:density_calculator}).
\item[Corrections] The 5 $\dndetadphi[incl,r,v,i]$ are corrected for
  secondary production and acceptance.  The correction for the
  secondary particle production is highly dependent on the vertex $z$
  coordinate.  The result is a per--ring, charged primary particle
  density $\dndetadphi[r,v,i]$ (see \secref{sec:sub:corrector}). 
\item[Histogram collector] Finally, the 5 $\dndetadphi[r,v,i]$ are
  summed into a single $\dndetadphi[v,i]$ histogram, taking care of
  the overlaps between the detector rings.  In principle, this
  histogram is independent of the vertex, except that the
  pseudo--rapidity range, and possible holes in that range, depends on
  $v_z$ --- or rather the bin in which the $v_z$ falls (see
  \secref{sec:sub:hist_collector}).
\end{description}

Each of these steps will be detailed in the following. 

\subsection{Event inspection}
\label{sec:sub:event_inspection}

The first thing to do, is to inspect the event for triggers.  A number
of trigger bits, like \INEL{}, \INELONE{}, \NSD{}, and so on is then
propagated to the \AOD{} output.  

Just after the sharing filter (described below) but before any further
processing, the vertex information is queried.  If there is no vertex
information, or if the vertex $z$ coordinate is outside the
pre--defined range, then no further processing of that event takes place. 

\subsection{Sharing filter}
\label{sec:sub:sharing_filter}

A particle originating from the vertex can, because of its incident
angle on the \FMD{} sensors traverse more than one strip (see
\figref{fig:share_fraction}).  This means that the energy loss of the
particle is distributed over 1 or more strips.  The signal in each
strip should therefore possibly be merged with its neighboring strip
signals to properly reconstruct the energy loss of a single particle.

\begin{figure}[htbp]
  \centering
  \includegraphics[keepaspectratio,height=3cm]{share_fraction}
  \caption{A particle traversing 2 strips and depositing energy in
    each strip. }
  \label{fig:share_fraction}
\end{figure}

The effect is most pronounced in low--flux\footnote{Events with a low
  hit density.} events, like proton--proton collisions or peripheral
Pb--Pb collisions, while in high--flux events the hit density is so
high that most likely each and every strip will be hit and the effect
cancel out on average.

Since the particles travel more or less in straight lines toward the
\FMD{} sensors, the sharing effect is predominantly in the $r$ or
\emph{strip} direction.  Only neighbouring strips in a given sector is
therefor investigated for this effect.  

Algorithm~\ref{algo:sharing} is applied to the signals in a given
sector.

\begin{algorithm}[htpb]
  \belowpdfbookmark{Algorithm 1}{algo:sharing}
  \SetKwData{usedThis}{current strip used}
  \SetKwData{usedPrev}{previous strip used}
  \SetKwData{Output}{output}
  \SetKwData{Input}{input}
  \SetKwData{Nstr}{\# strips}
  \SetKwData{Signal}{current}
  \SetKwData{Eta}{$\eta$}
  \SetKwData{prevE}{previous strip signal} 
  \SetKwData{nextE}{next strip signal} 
  \SetKwData{lowFlux}{low flux flag} 
  \SetKwFunction{SignalInStrip}{SignalInStrip}
  \SetKwFunction{MultiplicityOfStrip}{MultiplicityOfStrip}
  \usedThis $\leftarrow$ false\;
  \usedPrev $\leftarrow$ false\;
  \For{$t\leftarrow1$ \KwTo \Nstr}{ 
    \Output${}_t\leftarrow 0$\;
    \Signal $\leftarrow$ \SignalInStrip($t$)\;

    \uIf{\Signal is not valid}{ 
      \Output${}_t \leftarrow$ invalid\;
    }
    \uElseIf{\Signal is 0}{ 
      \Output${}_t \leftarrow$ 0\;
    }
    \Else{
      \Eta$\leftarrow$ $\eta$ of \Input${}_t$\;
      \prevE$\leftarrow$ 0\;
      \nextE$\leftarrow$ 0\;
      \lIf{$t \ne 1$}{ 
        \prevE$\leftarrow$ \SignalInStrip($t-1$)\;
      }
      \lIf{$t \ne $\Nstr}{ 
        \nextE$\leftarrow$ \SignalInStrip($t+1$)\;
      }
      \Output${}_t\leftarrow$
      \MultiplicityOfStrip(\Signal,\Eta,\prevE,\nextE,\\
      \hfill\lowFlux,$t$,\usedPrev,\usedThis)\;
    }   
  }
  \caption{Sharing correction}
  \label{algo:sharing}
\end{algorithm}

Here the function \FuncSty{SignalInStrip}($t$) returns the properly
path--length corrected signal in strip $t$.  The function
\FuncSty{MultiplicityOfStrip} is where the real processing takes
place (see page \pageref{func:MultiplicityOfStrip}). 

\begin{function}[htbp]
  \belowpdfbookmark{MultiplicityOfStrip}{func:MultiplicityOfStrip}
  \caption{MultiplicityOfStrip(\DataSty{current},$\eta$,\DataSty{previous},\DataSty{next},\DataSty{low
      flux flag},\DataSty{previous signal used},\DataSty{this signal
      used})} 
  \label{func:MultiplicityOfStrip}
  \SetKwData{Current}{current} 
  \SetKwData{Next}{next} 
  \SetKwData{Previous}{previous} 
  \SetKwData{lowFlux}{low flux flag}
  \SetKwData{usedPrev}{previous signal used}
  \SetKwData{usedThis}{this signal used}
  \SetKwData{lowCut}{low cut}
  \SetKwData{total}{Total}
  \SetKwData{highCut}{high cut}
  \SetKwData{Eta}{$\eta$}  
  \SetKwFunction{GetHighCut}{GetHighCut}
  \If{\Current is very large or \Current $<$ \lowCut} {
    \usedThis $\leftarrow$ false\;
    \usedPrev $\leftarrow$ false\;
    \Return{0}
  }
  \If{\usedThis}{ 
    \usedThis $\leftarrow$ false\;
    \usedPrev $\leftarrow$ true\;
    \Return{0}
  }
  \highCut $\leftarrow$ \GetHighCut($t$,\Eta)\;
  %\If{\Current $<$ \Next and \Next $>$ \highCut and \lowFlux set}{ 
  %  \usedThis $\leftarrow$ false\;
  %  \usedPrev $\leftarrow$ false\;
  %  \Return{0}
  %}
  \total $\leftarrow$ \Current\;
  \lIf{\lowCut $<$ \Previous $<$ \highCut and not \usedPrev}{ 
    \total $\leftarrow$ \total + \Previous\;
  }
  \If{\lowCut $<$ \Next $<$ \highCut}{ 
    \total $\leftarrow$ \total + \Next\;  
    \usedThis $\leftarrow$ true\;
  }
  \eIf{\total $>$ 0}{ 
    \usedPrev $\leftarrow$ true\;
    \Return{\total}
  }{
    \usedPrev $\leftarrow$ false\;
    \usedThis $\leftarrow$ false\;
    \Return{0}
  }
\end{function}
Here, the function \FuncSty{GetHighCut} evaluates a fit to the energy
distribution in the specified $\eta$ bin (see also
\secref{sec:sub:density_calculator}).  It returns
$$
\Delta_{mp} - 2 w
$$
where $\Delta_{mp}$ is the most probable energy loss, and $w$ is the
width of the Landau distribution.  

The \KwSty{if} in line 5, says that if the previous strip was merged
with current one, and the signal of the current strip was added to
that, then the current signal is set to 0, and we mark it as used for
the next iteration (\DataSty{previous signal used}$\leftarrow$true).

% The \KwSty{if} in line 10 checks if the current signal is smaller than
% the next signal, if the next signal is larger than the upper cut
% defined above, and if we have a low--flux event\footnote{Note, that in
%   the current implementation there are never any low--flux events.}.
% If that condition is met, then the current signal is the smaller of
% two possible candidates for merging, and it should be merged into the
% next signal.  Note, that this \emph{only} applies in low--flux events.

In line 11, % 15, 
we test if the previous signal lies between our low and
high cuts, and if it has not been marked as being used.  If so, we add
it to our current signal.  

The next \KwSty{if} on line 12 % 16 
checks if the next signal is within our
cut bounds.  If so, we add that signal to the current signal and mark
it as used for the next iteration (\DataSty{this signal
  used}$\leftarrow$true).  It will then be zero'ed on the next
iteration by the condition on line 6.

Finally, if our signal is still larger than 0, we return the signal
and mark this signal as used (\DataSty{previous signal
  used}$\leftarrow$true) so that it will not be used in the next
iteration. Otherwise, we mark the current signal and the next signal
as unused and return a 0. 


\subsection{Density calculator}
\label{sec:sub:density_calculator}

The density calculator loops over all the strip signals in the sharing
corrected\footnote{The sharing correction can be disabled, in which
  case the density calculator used the input \ESD{} signals.} \ESD{}
and calculates the inclusive (primary + secondary) charged particle
density in pre--defined $\etaphi$ bins.

\subsubsection{Inclusive number of charged particles} 
\label{sec:sub:sub:eloss_fits}

The number charged particles in a strip $\mult[,t]$ is calculated
using multiple Landau-like distributions fitted to the energy loss
spectrum of all strips in a given at a given $\eta$ bin.
\begin{align}
  \Delta_{i,mp} &= i (\Delta_{1,mp}+ \xi_1 \log(i))\nonumber\\
  \xi_i         &= i\xi_1\nonumber\\
  \sigma_i      &= \sqrt{i}\sigma_1\nonumber\\
  \mult[,t]     &= \frac{\sum_i^{N_{max}}
    i\,a_i\,F(\Delta_t;\Delta_{i,mp},\xi_i,\sigma_i)}{
    \sum_i^{N_{max}}\,a_i\,F(\Delta_t;\Delta_{i,mp},\xi_i,\sigma_i)}\quad,
\end{align}
where $F(x;\Delta_{mp},\xi,\sigma)$ is the evaluation of the Landau
distribution $f_L$ with most probable value $\Delta_{mp}$ and width
$\xi$, folded with a Gaussian distribution with spread $\sigma$ at the
energy loss $x$ \cite{nim:b1:16,phyrev:a28:615}.
\begin{align}
  \label{eq:energy_response}
  F(x;\Delta_{mp},\xi,\sigma) = \frac{1}{\sigma \sqrt{2 \pi}}
  \int_{-\infty}^{+\infty} d\Delta' f_{L}(x;\Delta',\xi)
  \exp{-\frac{(\Delta_{mp}-\Delta')^2}{2\sigma^2}}\quad,
\end{align}
where $\Delta_{1,mp}$, $\xi_1$, and $\sigma_1$ are the parameters for
the first MIP peak, $a_1=1$, and $a_i$ is the relative weight of the
$i$-fold MIP peak.  The parameters $\Delta_{1,mp}, \xi_1,
\sigma_1, \mathbf{a} = \left(a_2, \ldots a_{N_{max}}\right)$ are
obtained by fitting 
$$
F_j(x;C,\Delta_{mp},\xi,\sigma,\mathbf{a}) = C 
\sum_{i=1}^{j} a_i F(x;\Delta_{i,mp},\xi_{i},\sigma_i) 
$$
for increasing $j$ to the energy loss spectra in separate $\eta$ bins.
The fit procedure is stopped when one for $j+1$ 
\begin{itemize}
\item the reduced $\chi^2$ exceeds a certain threshold, or
\item the relative error $\delta p/p$ of any parameter of the fit
  exceeds a certain threshold, or 
\item when the weight $a_j+1$ is smaller than some number (typically
  $10^{-5}$). 
\end{itemize}
$N_{max}$ is then set to $j$.  Examples of the result of these fits
are given in \figref{fig:eloss_fits} in Appendix~\ref{app:eloss_fits}.

\subsubsection{Azimuthal Acceptance}

Before the signal $\mult[,t]$ can be added to the $\etaphi$
bin in one of the 5 per--ring histograms, it needs to be corrected for
the $\varphi$ acceptance of the strip.

The sensors of the \FMD{} are not perfect arc--segments --- the two
top corners are cut off to allow the largest possible sensor on a 6''
Si-wafer.   This means, however, that the strips in these outer
regions do not fully cover $2\pi$ in azimuth, and there is therefore a
need to correct for this limited acceptance.  

The acceptance correction is only applicable where the strip length
does not cover the full sector.  This is the case for the outer strips
in both the inner and outer type rings.  The acceptance correction is
then simply 
\begin{align}
  \label{eq:acc_corr}
  \Corners{} &= \frac{l_t}{\Delta\varphi}\quad
\end{align}
where $l_t$ is the strip length in radians at constant $r$, and
$\Delta\varphi$ is $2\pi$ divided by the number of sectors in the
ring (20 for inner type rings, and 40 for outer type rings). 

Note, that this correction is a hardware--related correction, and does
not depend on the properties of the collision (e.g., primary vertex
location). 

The final $\etaphi$ content of the 5 output vertex dependent,
per--ring histograms of the inclusive charged particle density is then
given by
\begin{align}
  \label{eq:density}
  \dndetadphi[incl,r,v,i\etaphi] &= \sum_t^{t\in\etaphi}
  \mult[,t]\,\Corners{}
\end{align}
where $t$ runs over the strips in the $\etaphi$ bin. 

\subsection{Corrections}
\label{sec:sub:corrector}

The corrections code receives the five vertex dependent,
per--ring histograms of the inclusive charged particle density
$\dndetadphi[incl,r,v,i]$ from the density calculator and applies
two corrections 

\subsubsection{Secondary correction}
%%
%%                hHits_FMD<d><r>_vtx<v> 
%% hCorrection = -----------------------
%%                hPrimary_FMD_<r>_vtx<v>
%%
%% where 
%% - hPrimary_FMD_<r>_vtx<vtx> is 2D of eta,phi for all primary ch
%%   particles
%% - hHits_FMD<d><r>_vtx<v>  is 2D of eta,phi for all track-refs that
%%   hit the FMD - The 2D version of hMCHits_nocuts_FMD<d><r>_vtx<v>
%%   used below. 
This is a 2 dimensional histogram generated from simulations, as the
ratio of primary particles to the total number of particles that fall
within an $\etaphi$ bin for a given vertex bin

\begin{align}
  \label{eq:secondary}
  \SecMap{} &=
  \frac{\sum_i^{\NV[,v]}\mult[,\text{primary},i]\etaphi}{
    \sum_i^{\NV[,v]}\mult[,\text{\FMD{}},i]\etaphi}\quad,
\end{align}
where $\NV[,v]$ is the number of events with a valid trigger and a
vertex in bin $v$, and $\mult[,\FMD{},i]$ is the total number of
charged particles that hit the \FMD{} in event $i$ in the specified
$\etaphi$ bin and $\mult[,\text{primary},i]$ is number of
primary charged particles in event $i$ within the specified
$\etaphi$ bin.

$\mult[,\text{primary}]\etaphi$ is given by summing over the
charged particles labelled as primaries \emph{at the time of the
  collision} as defined in the simulation code.  That is, it is the
number of primaries within the $\etaphi$ bin at the collision
point --- not at the \FMD{}.

$\SecMap$ is varies from $\approx 1.5$ for the most forward bins to
$\approx 3$ for the more central bins.  For pp, different event
generators were used and found to give compatible results within
3--5\%.   For pp, at least some millions of events must be
accumulated to reach satisfactory statistics.  For Pb--Pb where the
general hit density is larger, reasonable statistics can be achieved
with less data.  

\subsubsection{Acceptance due to dead channels}

Some of the strips in the \FMD{} have been marked up as \emph{dead},
meaning that they are not used in the reconstruction or analysis.
This leaves holes in the acceptance of each defined $\etaphi$
which need to be corrected for.  

Dead channels are marked specially in the \ESD{}s with the flag
\textit{Invalid Multiplicity}.  This is used in the analysis to build
up and event--by--event acceptance correction in each $\etaphi$
bin by calculating the ratio
\begin{align}
  \label{eq:dead_channels} 
  \DeadCh{} &= 
  \frac{\sum_t^{t\in\etaphi}\left\{\begin{array}{cl}
        1 & \text{if not dead}\\
        0 & \text{otherwise}
      \end{array}\right.}{\sum_t^{t\in\etaphi} 1}\quad,
\end{align}
where $t$ runs over the strips in the $\etaphi$ bin.  This correction
is obviously $v_z$ dependent since which $\etaphi$ bin a strip $t$
corresponds to depends on its relative position to the primary vertex.

Alternatively, pre--made acceptance factors can be used.  These are
made from the off-line conditions database (\OCDB{}).

The 5 output vertex dependent, per--ring histograms of the primary
charged particle density is then given by
\begin{align}
  \dndetadphi[r,v,i\etaphi] &=
  \SecMap{} \frac{1}{\DeadCh{}}\dndetadphi[incl,r,v,i\etaphi]
\end{align}

\subsection{Histogram collector}
\label{sec:sub:hist_collector}

The histogram collector collects the information from the 5 vertex
dependent, per--ring histograms of the primary charged particle
density $\dndetadphi[r,v,i]$ into a single vertex dependent histogram
of the charged particle density $\dndetadphi[v,i]$.  

To do this, it first calculates, for each vertex bin, the $\eta$ bin
range to use for each ring.  It investigates the secondary correction
maps $\SecMap{}$ to find the edges of each map.  The edges are given
by the $\eta$ range where $\SecMap{}$ is larger than some
threshold\footnote{Typically $t_s\approx 0.1$.}  $t_s$. The code
applies safety margin of a $N_{cut}$ bins\footnote{Typically
  $N_{cut}=1$.}, to ensure that the data selected does not have too
large corrections associated with it.

It then loops over the bins in the defined $\eta$ range and sums the
contributions from each of the 5 histograms.  In the $\eta$ ranges
where two rings overlap, the collector calculates the average and adds
the errors in quadrature\footnote{While not explicitly checked, it was
  found that the histograms agrees within error bars in the
  overlapping region}.

The output vertex dependent histogram of the primary
charged particle density is then given by
\begin{align}
  \label{eq:superhist}
  \dndetadphi[v,i\etaphi] &=
  \frac{1}{N_{r\in\etaphi}}\sum_{r}^{r\in\etaphi}  
  \dndetadphi[r,v,i\etaphi]\\
  \delta\left[\dndetadphi[v,i\etaphi]\right] &=
  \frac{1}{N_{r\in\etaphi}}\sqrt{\sum_{r}^{r\in\etaphi}   
    \delta\left[\dndetadphi[r,v,i\etaphi]\right]^2}
  \quad,
\end{align}
where $N_{r\in\etaphi}$ is the number of overlapping histograms
in the given $\etaphi$ bin. 

The histogram collector stores the found $\eta$ ranges in the
underflow bin of the histogram produced.  The content of the overflow
bins are 
\begin{align}
  \label{eq:overflow}
  I_{v,i}(\eta) &= 
  \frac{1}{N_{r\in(\eta)}}
  \sum_{r}^{r\in(\eta)} \left\{\begin{array}{cl} 
      0 & \eta \text{\ bin not selected}\\ 
      1 & \eta \text{\ bin selected}
      \end{array}\right.\quad,
\end{align}
where $N_{r\in(\eta)}$ is the number of overlapping histograms in the
given $\eta$ bin.  The subscript $v$ indicates that the content
depends on the current vertex bin of event $i$.

\section{Building the final $\dndeta$}
\label{sec:ana_aod}

To build the final $\dndeta$ distribution it is enough to sum
\eqref{eq:superhist} and \eqref{eq:overflow} over all interesting
events and correct for the acceptance $I(\eta)$ 
\begin{align}
  \dndetadphi[\etaphi] &= \sum_i^{\NA}\dndetadphi[i,v\etaphi]\\ 
  I(\eta) &= \sum_i^{\NA}I_{i,v}(\eta)\quad.
\end{align}
Note, that $I(\eta)\le\NA$.  

We then need to normalise to the total number of events $N_X$, given
by 
\begin{align}
  \N{X}{} &= \frac{1}{\epsilon_X}\left[\NA + \alpha(\NnotV -
    \beta)\right]  \label{eq:fulleventnorm}\\
  & = \frac{1}{\epsilon_X}\left[\NA + \frac{\NA}{\NV}(\NT-\NV{} -
    \beta)\right]\nonumber \\
  & =\frac{1}{\epsilon_X}\NA\left[1+\frac{1}{\epsilon_V}-1-
    \frac{\beta}{\NV}\right]\nonumber\\ 
  & = \frac{1}{\epsilon_X}\frac{1}{\epsilon_V}\NA
  \left(1-\frac{\beta}{\NT{}}\right)\nonumber
\end{align}
where
\begin{description}
\item[$\epsilon_X$]  is the trigger efficiency for type
  $X\in[\text{\INEL},\text{\INELONE},\text{\NSD},...]$
\item[$\epsilon_V=\frac{\NV{}}{\NT{}}$] is the vertex efficiency
  evaluated over the data.
\item[$\NA$] is the number of events with a trigger \emph{and} a valid
  vertex in the selected range
\item[$\NV{}$] is the number of events with a trigger \emph{and} a valid
  vertex. 
\item[$\NT$] is the number of events with a trigger.
\item[$\NnotV{}=\NT-\NV{}$] is the number of events with a trigger
  \emph{but no} valid vertex
\item[$\alpha=\frac{\NA}{\NV}$] is the fraction of accepted events of
  the total number of events with a trigger and valid vertex.  
\item[$\beta=\N{a}{}+\N{b}{}-\N{e}{}$] is the number of background
  events \emph{with} a valid off-line trigger.
\end{description}
The two terms under the parenthesis in \eqref{eq:fulleventnorm} refers
to the observed number of event $\NA$, and the events missed because
of no vertex reconstruction.  Note, for $\beta\ll\NT{}$
\eqref{eq:fulleventnorm} reduces to the simpler expression
$$
\N{X}{} = \frac1{\epsilon_X}\frac1{\epsilon_V}\NA{}
$$
The trigger efficiency $\epsilon_X$ for a given trigger type $X$ is
evaluated from simulations as
\begin{align}
  \epsilon_X = \frac{\N{X\wedge \text{T}}{}}{\N{X}{}}\quad,
\end{align}
that is, the ratio of number of events of type $X$ with a
corresponding trigger to the number of events of type $X$. 

The final event--normalised charged particle density then becomes 
\begin{align}
  \frac{1}{N}\frac{dN_{\text{ch}}}{d\eta} &= 
  \frac{1}{\N{X}{}} \int_0^{2\pi} d\varphi
  \frac{\dndetadphi[\etaphi]}{I(\eta)}
  \label{eq:eventnormdndeta}
\end{align}

If the trigger $X$ introduces a bias on the measured number of events,
then \eqref{eq:eventnormdndeta} need to be modified to 
\begin{align}
  \frac{1}{N}\frac{dN_{\text{ch}}}{d\eta} &= 
  \frac{1}{\N{X}{}} \int_0^{2\pi} d\varphi
  \frac{\frac{1}{B\etaphi}\dndetadphi[\etaphi]}{I(\eta)}
  \label{eq:eventnormdndeta2}\quad,
\end{align}
where $B\etaphi$ is the bias correction.  This is typically
calculated from simulations using the expression 
\begin{align}
  B\etaphi = \frac{\frac{1}{\N{X\wedge
        \text{T}}{}}\sum_i^{\N{X\wedge \text{T}}{}}
    \mult[,\text{primary}]\etaphi}{\frac{1}{\N{X}{}}\sum_i^{\N{X}{}}
    \mult[,\text{primary}]\etaphi}
\end{align}


\section{Using the per--event $\dndetadphi[i,v]$ histogram for other
  analysis} 

\subsection{Multiplicity distribution} 

To build the multiplicity distribution for a given $\eta$ range
$[\eta_1,\eta_2]$, one needs to find the total multiplicity in that
$\eta$ range for each event. To do so, one should sum the
$\dndetadphi[i,v]$ histogram over all $\varphi$ and in the selected
$\eta$ range.
\begin{align}
  n'_{i[\eta_1,\eta_2]}, &= \int_{\eta_1}^{\eta_2}d\eta\int_0^{2\pi}d\varphi
  \dndetadphi[i,v]\quad.\nonumber
\end{align}
However, $n'_i$ is not corrected for the coverage in $\eta$ for the
particular vertex range $v$.  One therefor needs to correct for the
number of missing bins in the range $[\eta_1,\eta_2]$.  Suppose
$[\eta_1,\eta_2]$ covers $N_{[\eta_1,\eta_2]}$ $\eta$ bins, then the acceptance
correction is given by 
\begin{align}
  A_{i,[\eta_1,\eta_2]} = \frac{N_{[\eta_1,\eta_2]}}{\int_{\eta_1}^{\eta_2}d\eta\,
    I_{i,v}(\eta)}\quad.\nonumber
\end{align}
The per--event multiplicity is then given by 
\begin{align}
  n_{i,[\eta_1,\eta_2]} &= A_{i,[\eta_1,\eta_2]}\,n'_{i,[\eta_1,\eta_2]}\nonumber\\
  &= \frac{N_{[\eta_1,\eta_2]}}{\int_{\eta_1}^{\eta_2}\eta
    I_{i,v}(\eta)} \int_{\eta_1}^{\eta_2}d\eta\int_0^{2\pi}d\varphi
  \dndetadphi[i,v]
  \label{eq:event_n}
\end{align}

\subsection{Forward--Backward correlations} 

To do forward--backward correlations, one need to calculate
$n_{i,[\eta_1,\eta_2]}$ as shown in \eqref{eq:event_n} in two bins
$n_{i,[\eta_1,\eta_2]}$ and $n_{i,[-\eta_2,-\eta_1]}$ \textit{e.g.},
$n_{i,f}=n_{i,[-3,-1]}$ and $n_{i,b}=n_{i,[1,3]}$. 

\clearpage
\section{Some results}

%% \figurename{}s \ref{fig:1} to \ref{fig:3} shows some results.
Figures below show some examples.  Note these are not finalised
plots. 

\begin{figure}[hbp]
  \centering
  \includegraphics[keepaspectratio,width=\textwidth]{%
    dndeta_pp_0900GeV_INEL_m10p10cm}
  \caption{$\dndeta$ for pp for \INEL{} events at $\sqrt{s}=\GeV{900}$,
    $\cm{-10}\le v_z\le\cm{10}$, rebinned by a factor 5.  Middle panel
    shows the ratio of ALICE data to UA5, and the bottom panel shows
    the ratio of the right (positive) side to the left (negative) side
    of the forward $\dndeta$.}
  \label{fig:1}
\end{figure} 

\iffalse
\begin{figure}[tbp]
  \centering
  \includegraphics[keepaspectratio,width=\textwidth]{%
    dndeta_0900GeV_m10-p10cm_rb05_inelgt0}
  \caption{$\dndeta$ for pp for \INELONE{} events at
    $\sqrt{s}=\GeV{900}$, $\cm{-10}\le v_z\le\cm{10}$, rebinned by a
    factor 5.  Comparisons to other measurements shown where
    applicable}
  \label{fig:2}
\end{figure} 
\begin{figure}[tbp]
  \centering
  \includegraphics[keepaspectratio,width=\textwidth]{%
    dndeta_0900GeV_m10-p10cm_rb05_nsd}
  \caption{$\dndeta$ for pp for \NSD{} events at $\sqrt{s}=\GeV{900}$,
    $\cm{-10}\le v_z\le\cm{10}$, rebinned by a factor 5.  Comparisons
    to other measurements shown where applicable}
  \label{fig:3}
\end{figure} 
\fi

\clearpage
%% \currentpdfbookmark{Appendices}{Appendices}
\appendix 
\section{Nomenclature} 
\label{app:nomen}

\begin{table}[hbp]
  \centering
  \begin{tabular}[t]{|lp{.8\textwidth}|}
    \hline 
    \textbf{Symbol}&\textbf{Description}\\
    \hline 
    \INEL & In--elastic event\\ 
    \INELONE & In--elastic event with at least one tracklet in the
    \SPD{} in the region $-1\le\eta\le1$\\ 
    \NSD{} & Non--single--diffractive event.  Single diffractive
    events are events where one of the incident collision systems
    (proton or nucleus) is excited and radiates particles, but there
    is no other processes taking place\\ 
    \hline
    $\NT{}$ & Number of events with a valid trigger\\
    $\NV{}$ & Number of events with a valid trigger \emph{and} a valid
    vertex.\\  
    $\NA{}$ & Number of events with a valid trigger
    \emph{and} a valid vertex \emph{within} the selected vertex range.\\ 
    $\N{a,c,ac,e}{}$ & Number of events with background triggers $A$,
    $B$, $AC$, or $E$, \emph{and} a valid off-line trigger of the
    considered type.   Background triggers are typically flagged with
    the trigger words \texttt{CINT1-A},  \texttt{CINT1-C},
    \texttt{CINT1-AC}, \texttt{CINT1-E}, or similar.\\
    \hline
    $\mult{}$ & Charged particle multiplicity\\ 
    $\mult[,\text{primary}]$ & Primary charged particle multiplicity
    as given by simulations\\ 
    $\mult[,\text{\FMD{}}]$ & Number of charged particles that hit the
    \FMD{} as given by simulations\\ 
    $\mult[,t]$ & Number of charged particles in an \FMD{} strip as
    given by evaluating the energy response functions $F$\\ 
    \hline
    $F$ & Energy response function (see \eqref{eq:energy_response})\\
    $\Delta_{mp}$ & Most probably energy loss\\ 
    $\xi$ & `Width' parameter of a Landau distribution\\
    $\sigma$ & Variance of a Gaussian distribution\\ 
    $a_i$ & Relative weight of the $i$--fold MIP peak in the energy
    loss spectra.\\ 
    \hline
    $\Corners{}$ & Azimuthal acceptance of strip $t$\\ 
    $\SecMap{}$ & Secondary particle correction factor in $\etaphi$
    for a given vertex bin $v$\\  
    $\DeadCh{}$ & Acceptance in $\etaphi$ for a given vertex bin $v$\\ 
    \hline
    $\dndetadphi[incl,r,v,i]$ & Inclusive (primary \emph{and}
    secondary) charge particle density in event $i$ with vertex $v$,
    for \FMD{} ring $r$.\\ 
    $\dndetadphi[r,v,i]$ & Primary charged particle
    density in event $i$ with vertex $v$ for \FMD{} ring $r$. \\
    $\dndetadphi[v,i]$ & Primary charged particle density in event $i$
    with vertex $v$\\  
    $I_{v,i}(\eta)$ & $\eta$ acceptance of event $i$ with vertex $v$\\ 
    $I(\eta)$ & Integrated $\eta$ acceptance over $\NA$ events.
    Note, that this has a value of $\NA$ for $(\eta)$ bins where we
    have full coverage\\ 
    \hline 
    $X_t$ & Value $X$ for strip number $t$ (0-511 for inner rings,
    0-255 for outer rings)\\ 
    $X_r$ & Value $X$ for ring $r$ (where rings are \FMD{1i},
    \FMD{2i}, \FMD{2o}, \FMD{3o}, and \FMD{3i} in decreasing $\eta$
    coverage).\\ 
    $X_v$ & Value $X$ for vertex bin $v$ (typically 10 bins from -10cm
    to +10cm)\\ 
    $X_i$ & Value $X$ for event $i$\\
    \hline
  \end{tabular}
  \caption{Nomenclature used in this document}
  \label{tab:nomenclature}
\end{table}
\clearpage


\section{Second pass example code}
\label{app:exa_pass2}
\lstset{basicstyle=\small\ttfamily,% 
  keywordstyle=\color[rgb]{0.627,0.125,0.941}\bfseries,% 
  identifierstyle=\color[rgb]{0.133,0.545,0.133}\itshape,%
  commentstyle=\color[rgb]{0.698,0.133,0.133},%
  stringstyle=\color[rgb]{0.737,0.561,0.561},
  emph={TH2D,TH1D,TFile,TTree,AliAODForwardMult},emphstyle=\color{blue},%
  emph={[2]dndeta,sum,norm},emphstyle={[2]\bfseries\underbar},%
  emph={[3]file,tree,mult,nV,nBg,nA,nT,i,gSystem},emphstyle={[3]},%
  language=c++,%
}
\begin{lstlisting}[caption={Example 2\textsuperscript{nd} pass code to
    do $\dndeta$},label={lst:example},frame=single,captionpos=b]
void Analyse(int mask=AliAODForwardMult::kInel,
             float vzLow=-10, float vzHigh=10, float trigEff=1)
{ 
  gSystem->Load("libANALYSIS.so");      // Load analysis libraries
  gSystem->Load("libANALYSISalice.so"); // General ALICE stuff
  gSystem->Load("libPWGLFforward2.so");  // Forward analysis code

  int                nT      = 0;              // # of ev. w/trigger
  int                nV      = 0;              // # of ev. w/trigger&vertex
  int                nA      = 0;              // # of accepted ev.
  int                nBg     = 0;              // # of background ev
  TH2D*              sum     = 0;              // Summed hist
  AliAODForwardMult* mult    = 0;              // AOD object
  TFile*             file    = TFile::Open("AliAODs.root","READ");
  TTree*             tree    = static_cast<TTree*>(file->Get("aodTree"));
  tree->SetBranchAddress("Forward", &forward); // Set the address

  for (int i = 0; i < tree->GetEntries(); i++) { 
    // Read the i'th event 
    tree->GetEntry(i);

    // Create sum histogram on first event - to match binning to input
    if (!sum) 
      sum = static_cast<TH2D*>(mult->GetHistogram()->Clone("d2ndetadphi"));
    
    // Calculate beta=A+C-E
    if (mult->IsTriggerBits(mask|AliAODForwardMult::kA))    nBg++;
    if (mult->IsTriggerBits(mask|AliAODForwardMult::kC))    nBg++;
    if (mult->IsTriggerBits(mask|AliAODForwardMult::kE))    nBg--;

    // Other trigger/event requirements could be defined 
    if (!mult->IsTriggerBits(mask)) continue; 
    nT++;

    // Check if we have vertex and select vertex range (in centimeters) 
    if (!mult->HasIpZ()) continue;
    nV++;
    
    if (!mult->InRange(vzLow, vzHigh) continue; 
    nA++;

    // Add contribution from this event
    sum->Add(&(mult->GetHistogram()));
  }

  // Get acceptance normalisation from underflow bins 
  TH1D* norm   = sum->ProjectionX("norm", 0, 0, "");
  // Project onto eta axis - _ignoring_underflow_bins_!
  TH1D* dndeta = sum->ProjectionX("dndeta", 1, -1, "e");
  // Normalize to the acceptance, and scale by the vertex efficiency 
  dndeta->Divide(norm);
  dndeta->Scale(trigEff * nT/nV / (1 - nBg/nT), "width");
  // And draw the result
  dndeta->Draw();
}
\end{lstlisting}

\section{$\Delta E$ fits} 
\label{app:eloss_fits}

\begin{figure}[htbp]
  \centering
  \includegraphics[keepaspectratio,width=\textwidth]{eloss_fits}
  \caption{Summary of energy loss fits in each $\eta$ bin (see also
    \secref{sec:sub:sub:eloss_fits}).
    \newline
    On the left side: Top panel shows the
    reduced $\chi^2$, second from the top shows the found
    scaling constant, 3\textsuperscript{rd} from the top is
    the most probable energy loss $\Delta_{mp}$, 4\textsuperscript{th}
    shows the width parameter $\xi$ of the Landau, and the
    5\textsuperscript{th} is the Gaussian width $\sigma$.
    $\Delta_{mp}$, $\xi$, and $\sigma$ have units of $\Delta E/\Delta
    E_{mip}$. 
    \newline
    On the right: The top panel shows the maximum number of
    multi--particle signals that where fitted, and the 4 bottom panels
    shows the weights $a_2,a_3,a_4,$ and $a_5$ for 2, 3, 4, and 5
    particle responses.}
  \label{fig:eloss_fits}
\end{figure}

\clearpage
\currentpdfbookmark{References}{References}
\begin{thebibliography}{99}
\bibitem{FWD:2004mz} \ALICE{} Collaboration, Bearden, I.~G.\ \textit{et al}
  \textit{ALICE technical design report on forward detectors: FMD, T0
    and V0}, \CERN{}, 2004, CERN-LHCC-2004-025
\bibitem{cholm:2009} Christensen, C.~H., \textit{The ALICE Forward
    Multiplicity Detector --- From Design to Installation},
  Ph.D.~thesis, University of Copenhagen, 2009,
  \url{http://www.nbi.dk/~cholm/}. 
\bibitem{nim:b1:16} 
%% \bibitem{Hancock:1983ry}
  S.~Hancock, F.~James, J.~Movchet {\it et al.},
  ``Energy Loss Distributions For Single Particles And Several
  Particles In A Thin Silicon Absorber,'' Nucl.\ Instrum.\ Meth.\
  \textbf{B1} (1984)  16, \url{http://cdsweb.cern.ch/record/147286/files/cer-000058451.pdf}.
\bibitem{phyrev:a28:615} 
%% \bibitem{Hancock:1983fp}
  S.~Hancock, F.~James, J.~Movchet {\it et al.}, ``Energy Loss And
  Energy Straggling Of Protons And Pions In The Momentum Range
  0.7-gev/c To 115-gev/c,'' Phys.\ Rev.\ \textbf{A28} (1983) 615,
  \url{http://cdsweb.cern.ch/record/145395/files/PhysRevA.28.615.pdf}. 
\end{thebibliography}
\end{document}

% Local Variables:
%   ispell-local-dictionary: "british"
% End:
%
% LocalWords:  tracklet diffractive IsTriggerBits AliAODForwardMult ProjectionX
