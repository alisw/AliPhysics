///
/// \file PWGCF/FEMTOSCOPY/macros/Train/PionPionFemto/AddTaskPionPion.C
/// \author Andrew Kubera, Ohio State University, andrew.kubera@cern.ch
///

#ifndef __CINT__

#include <TString.h>
#include <TList.h>
#include <TObjArray.h>

#include "AliAnalysisTaskFemto.h"
#include "AliAnalysisManager.h"

#endif

///
/// \brief Adds an AliAnalysisTaskFemto analysis object, constructed
///        with parameters provided, to the global AliAnalysisManager.
///
/// This macro creates and returns an AliAnalysisTaskFemto object.
/// The task object is given a macro
/// is given the config macro "Train/PionPionFemto/ConfigFemtoAnalysis.C"
/// which is run to create the analysis objects.
/// This is fixed (for now), and if an alternative is required, you
/// should use the general AddTaskFemto.C macro.
///
/// Subwagons are supported, the name of which will be appended to
/// the task name.
/// The task name by default is "TaskPionPionFemto" which cannot be
/// changed.
///
/// The output container name is fixed at the standard "femtolist".
///
/// \param configuration
///     A string containing commands to execute, separated by semicolons.
///     Assign the old parameters using this command.
///     Single quotes are turned to double quotes.
///
///     * macro: Path to the FemtoConfig macro to load; "%%" is
///          expaneded to directory containing this file.
///     * output_filename: Name of the output file to produce.
///         Default generated by AliAnalysisManager::GetCommonFileName()
///     * output_container: Name of top-level ROOT directory in the output file.
///         Default is the classic 'PWG2FEMTO'.
///     * container: Name of the AliAnalysis container.
///     * task_name: Name of the AliAnalysisTask - May need to be unique...
///     * verbose: Task created in verbose mode
///
/// \param params
///     A string forwarded to the ConfigFemtoAnalysis macro for parsing.
///     This string is wrapped in double-quotes so escaping some to
///     ensure results is a string is unneccessary.
///
/// \param subwagon_suffix
///     If this macro is run in a train with subwagons, this will be
///     set with the identifier.
///
AliAnalysisTaskFemto* AddTaskPionPion(TString configuration,
                                      TString params,
                                      TString subwagon_suffix="")
{ // Adds a Pion-Pion Femtoscopy task to the manager

  const TString AUTO_DIRECTORY = "$ALICE_PHYSICS/PWGCF/FEMTOSCOPY/macros/Train/PionPionFemto",
                DEFAULT_MACRO = "%%/ConfigFemtoAnalysis.C",
                DEFAULT_CONTAINER_NAME = "pionpion_femtolist",
                DEFAULT_OUTPUT_CONTAINER = "PWG2FEMTO",
                DEFAULT_TASK_NAME = "TaskPionPion",
                DEFAULT_SUBWAGON_TYPE = "centrality";

  // Get the global manager
  AliAnalysisManager *mgr = AliAnalysisManager::GetAnalysisManager();
  if (!mgr) {
    Error("AddTaskPionPion", "Could not get the global AliAnalysisManager.");
    return NULL;
  }

  TString macro = DEFAULT_MACRO,
          output_filename = mgr->GetCommonFileName(),
          task_name = DEFAULT_TASK_NAME,
          container = DEFAULT_CONTAINER_NAME,
          output_container = DEFAULT_OUTPUT_CONTAINER,
          subwagon_type = DEFAULT_SUBWAGON_TYPE;

  bool verbose = kFALSE;

  TObjArray* lines = configuration.Tokenize("\n;");

  TIter next_line(lines);
  TObject *line_obj = NULL;

  while (line_obj = next_line()) {
    TString cmd = ((TObjString*)line_obj)->String().Strip(TString::kBoth, ' ');
    cmd.ReplaceAll("'", '"');
    std::cout << "running `" << cmd  << "`\n";
    gROOT->ProcessLineFast(cmd + ';');
  }

  // Replace %% with this directory for convenience
  macro.ReplaceAll("%%", AUTO_DIRECTORY);

  // Dealing with subwagons
  if (!subwagon_suffix.IsWhitespace()) {
    subwagon_type.ToLower();

    if (subwagon_type == "centrality") {
      params = TString::Format("~use_subwagon_centrality=true; ~subwagon_centrality='%s';", subwagon_suffix.Data()) + params.Data();
    } else {
      std::cerr << "AddTaskPionPion - Unexpected subwagon_type '" << subwagon_type << "' - Ignoring\n";
    }
  }

  std::cout << "[AddTaskPionPion]\n"
               "   output: '" << output_filename << "'\n"
               "   macro: '" << macro << "'\n"
               "   params: '" << params << "'\n";

  // The analysis config macro for PionPionFemto accepts a single string
  // argument, which it interprets.
  // This line escapes some escapable characters (backslash, newline, tab)
  // and wraps that string in double quotes, ensuring that the interpreter
  // reads a string when passing to the macro.
  const TString analysis_params = '"' + params.ReplaceAll("\\", "\\\\")
                                              .ReplaceAll("\n", "\\n")
                                              .ReplaceAll("\"", "\\\"")
                                              .ReplaceAll("\t", "\\t") + '"';

  AliAnalysisTaskFemto *taskfemto = new AliAnalysisTaskFemto(
    task_name,
    macro,
    analysis_params,
    verbose
  );

  mgr->AddTask(taskfemto);

  const TString outputfile = (output_container == "")
                           ? output_filename
                           : TString::Format("%s:%s", output_filename.Data(), output_container.Data());

  AliAnalysisDataContainer *out_container = mgr->CreateContainer(container,
                                                                 TList::Class(),
                                                                 AliAnalysisManager::kOutputContainer,
                                                                 outputfile);

  // connect task to the containers
  mgr->ConnectInput(taskfemto, 0, mgr->GetCommonInputContainer());
  mgr->ConnectOutput(taskfemto, 0, out_container);

  // Return the task pointer
  return taskfemto;
}
